name: Security Refresh & Scan

on:
  schedule:
    # Weekly - Sunday 03:00 UTC - rebuild with latest base image and security patches
    - cron: "0 3 * * 0"
  workflow_dispatch:

env:
  IMAGE: engabelal/cloudy-runner

jobs:
  amd64:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Load versions
        run: |
          set -a
          source versions.env
          set +a
          echo "NODE_VERSION=$NODE_VERSION" >> $GITHUB_ENV
          echo "TERRAFORM_VERSION=$TERRAFORM_VERSION" >> $GITHUB_ENV
          echo "ANSIBLE_VERSION=$ANSIBLE_VERSION" >> $GITHUB_ENV
          echo "KUBECTL_VERSION=$KUBECTL_VERSION" >> $GITHUB_ENV
          echo "HELM_VERSION=$HELM_VERSION" >> $GITHUB_ENV
          echo "KUSTOMIZE_VERSION=$KUSTOMIZE_VERSION" >> $GITHUB_ENV
          echo "YQ_VERSION=$YQ_VERSION" >> $GITHUB_ENV

      - name: Build amd64 (no cache - fresh security patches)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.amd64
          platforms: linux/amd64
          push: true
          tags: ${{ env.IMAGE }}:amd64-security
          build-args: |
            NODE_VERSION=${{ env.NODE_VERSION }}
            TERRAFORM_VERSION=${{ env.TERRAFORM_VERSION }}
            ANSIBLE_VERSION=${{ env.ANSIBLE_VERSION }}
            KUBECTL_VERSION=${{ env.KUBECTL_VERSION }}
            HELM_VERSION=${{ env.HELM_VERSION }}
            KUSTOMIZE_VERSION=${{ env.KUSTOMIZE_VERSION }}
            YQ_VERSION=${{ env.YQ_VERSION }}
          no-cache: true
          pull: true
          load: true

      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE }}:amd64-security
          format: 'sarif'
          output: 'trivy-amd64-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-amd64-results.sarif'
          category: 'trivy-amd64'

      - name: Generate security report
        if: always()
        run: |
          docker run --rm aquasec/trivy:latest image \
            --severity CRITICAL,HIGH,MEDIUM \
            --format table \
            ${{ env.IMAGE }}:amd64-security > security-report-amd64.txt || true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-amd64
          path: security-report-amd64.txt
          retention-days: 30

  arm64:
    runs-on: ubuntu-24.04-arm  # Native ARM runner - no QEMU emulation!
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Load versions
        run: |
          set -a
          source versions.env
          set +a
          echo "NODE_VERSION=$NODE_VERSION" >> $GITHUB_ENV
          echo "TERRAFORM_VERSION=$TERRAFORM_VERSION" >> $GITHUB_ENV
          echo "ANSIBLE_VERSION=$ANSIBLE_VERSION" >> $GITHUB_ENV
          echo "KUBECTL_VERSION=$KUBECTL_VERSION" >> $GITHUB_ENV
          echo "HELM_VERSION=$HELM_VERSION" >> $GITHUB_ENV
          echo "KUSTOMIZE_VERSION=$KUSTOMIZE_VERSION" >> $GITHUB_ENV
          echo "YQ_VERSION=$YQ_VERSION" >> $GITHUB_ENV

      - name: Build arm64 (no cache - fresh security patches)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.arm64
          platforms: linux/arm64
          push: true
          tags: ${{ env.IMAGE }}:arm64-security
          build-args: |
            NODE_VERSION=${{ env.NODE_VERSION }}
            TERRAFORM_VERSION=${{ env.TERRAFORM_VERSION }}
            ANSIBLE_VERSION=${{ env.ANSIBLE_VERSION }}
            KUBECTL_VERSION=${{ env.KUBECTL_VERSION }}
            HELM_VERSION=${{ env.HELM_VERSION }}
            KUSTOMIZE_VERSION=${{ env.KUSTOMIZE_VERSION }}
            YQ_VERSION=${{ env.YQ_VERSION }}
          no-cache: true
          pull: true
          load: true

      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE }}:arm64-security
          format: 'sarif'
          output: 'trivy-arm64-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-arm64-results.sarif'
          category: 'trivy-arm64'

      - name: Generate security report
        if: always()
        run: |
          docker run --rm aquasec/trivy:latest image \
            --severity CRITICAL,HIGH,MEDIUM \
            --format table \
            ${{ env.IMAGE }}:arm64-security > security-report-arm64.txt || true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-arm64
          path: security-report-arm64.txt
          retention-days: 30

  manifest:
    runs-on: ubuntu-latest
    needs: [amd64, arm64]
    permissions:
      contents: read

    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Create and push security manifest
        run: |
          docker buildx imagetools create \
            -t ${{ env.IMAGE }}:security-latest \
            ${{ env.IMAGE }}:amd64-security \
            ${{ env.IMAGE }}:arm64-security

          echo "âœ… Security-refreshed multi-arch image published: ${{ env.IMAGE }}:security-latest"

  notify:
    runs-on: ubuntu-latest
    needs: [manifest]
    if: always()
    permissions:
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download security reports
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: reports/

      - name: Create security summary
        run: |
          cat > security-summary.md <<'EOF'
          # ðŸ”’ Weekly Security Refresh Report

          **Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Workflow**: Security Refresh & Scan

          ## ðŸ“¦ Images Rebuilt

          - âœ… `engabelal/cloudy-runner:amd64-security`
          - âœ… `engabelal/cloudy-runner:arm64-security`
          - âœ… `engabelal/cloudy-runner:security-latest` (multi-arch)

          ## ðŸ›¡ï¸ Security Scanning

          Images scanned with [Trivy](https://github.com/aquasecurity/trivy) for:
          - Critical vulnerabilities
          - High severity issues
          - Medium severity issues

          Results uploaded to GitHub Security tab.

          ## ðŸ“‹ Details

          - **Base Image**: Ubuntu 24.04 LTS (pulled fresh)
          - **Cache**: Disabled (ensures latest security patches)
          - **Scan Level**: CRITICAL, HIGH, MEDIUM

          ## ðŸ”— Links

          - [Security Tab](https://github.com/${{ github.repository }}/security/code-scanning)
          - [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---

          This is an automated weekly security refresh to ensure the latest base image security patches are applied.
          EOF

          cat security-summary.md

      - name: Create or update security issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create labels if they don't exist (ignore errors if they already exist)
          gh label create "security-refresh" --description "Weekly security refresh" --color "d73a4a" 2>/dev/null || true
          gh label create "automated" --description "Automated workflow" --color "ededed" 2>/dev/null || true

          # Check if an open security issue exists with our title pattern
          ISSUE_NUMBER=$(gh issue list \
            --state open \
            --search "Weekly Security Refresh in:title" \
            --json number \
            --jq '.[0].number // empty')

          if [ -z "$ISSUE_NUMBER" ]; then
            # Create new issue only if security scan found issues
            if [ "${{ needs.amd64.result }}" != "success" ] || [ "${{ needs.arm64.result }}" != "success" ]; then
              gh issue create \
                --title "ðŸ”’ Weekly Security Refresh - $(date -u '+%Y-%m-%d')" \
                --body-file security-summary.md \
                --label "security-refresh" \
                --label "automated"
              echo "âš ï¸ Created security issue due to scan failures"
            else
              echo "âœ… Security refresh completed successfully, no issues found"
            fi
          else
            # Update existing issue
            gh issue comment "$ISSUE_NUMBER" \
              --body-file security-summary.md
            echo "âœ… Updated existing security issue #$ISSUE_NUMBER"
          fi

      - name: Job summary
        if: always()
        run: |
          cat security-summary.md >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.amd64.result }}" = "success" ] && [ "${{ needs.arm64.result }}" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Security refresh completed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Some security scans reported issues. Check the Security tab for details.**" >> $GITHUB_STEP_SUMMARY
          fi
