name: Version Checker

on:
  schedule:
    # Run weekly on Monday at 09:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

env:
  GH_TOKEN: ${{ github.token }}

jobs:
  check-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Load current versions
        id: current
        run: |
          set -a
          source versions.env
          set +a

          echo "node_current=$NODE_VERSION" >> $GITHUB_OUTPUT
          echo "terraform_current=$TERRAFORM_VERSION" >> $GITHUB_OUTPUT
          echo "ansible_current=$ANSIBLE_VERSION" >> $GITHUB_OUTPUT
          echo "kubectl_current=$KUBECTL_VERSION" >> $GITHUB_OUTPUT
          echo "helm_current=$HELM_VERSION" >> $GITHUB_OUTPUT
          echo "kustomize_current=$KUSTOMIZE_VERSION" >> $GITHUB_OUTPUT
          echo "yq_current=$YQ_VERSION" >> $GITHUB_OUTPUT

      - name: Fetch latest versions
        id: latest
        run: |
          # Node.js LTS
          NODE_LATEST=$(curl -s https://nodejs.org/dist/index.json | jq -r '[.[] | select(.lts)] | .[0].version' | sed 's/v//')
          echo "node_latest=$NODE_LATEST" >> $GITHUB_OUTPUT

          # Terraform (stable 1.9.x for CI/CD)
          TERRAFORM_LATEST=$(curl -s 'https://releases.hashicorp.com/terraform/index.json' | jq -r '.versions | keys | map(select(test("^1\\.9\\."))) | sort | .[-1]')
          echo "terraform_latest=$TERRAFORM_LATEST" >> $GITHUB_OUTPUT

          # Ansible
          ANSIBLE_LATEST=$(curl -s https://pypi.org/pypi/ansible/json | jq -r '.releases | keys | map(select(startswith("10."))) | sort | .[-1]')
          echo "ansible_latest=$ANSIBLE_LATEST" >> $GITHUB_OUTPUT

          # kubectl (stable-1.31 for compatibility)
          KUBECTL_LATEST=$(curl -sL https://dl.k8s.io/release/stable-1.31.txt)
          echo "kubectl_latest=$KUBECTL_LATEST" >> $GITHUB_OUTPUT

          # Helm (v3.x stable)
          HELM_LATEST=$(curl -s https://api.github.com/repos/helm/helm/releases | jq -r '[.[] | select(.tag_name | startswith("v3.")) | select(.prerelease==false and .draft==false)][0].tag_name')
          echo "helm_latest=$HELM_LATEST" >> $GITHUB_OUTPUT

          # Kustomize
          KUSTOMIZE_LATEST=$(curl -s https://api.github.com/repos/kubernetes-sigs/kustomize/releases/latest | jq -r '.tag_name')
          echo "kustomize_latest=$KUSTOMIZE_LATEST" >> $GITHUB_OUTPUT

          # yq
          YQ_LATEST=$(curl -s https://api.github.com/repos/mikefarah/yq/releases/latest | jq -r '.tag_name')
          echo "yq_latest=$YQ_LATEST" >> $GITHUB_OUTPUT

      - name: Compare versions and create report
        id: compare
        run: |
          cat > version-report.md <<'EOF'
          # ðŸ” Version Check Report

          ## ðŸ“Š Current vs Latest Versions

          | Tool | Current | Latest | Status |
          |------|---------|--------|--------|
          EOF

          UPDATES_AVAILABLE=false

          # Node.js
          if [ "${{ steps.current.outputs.node_current }}" = "${{ steps.latest.outputs.node_latest }}" ]; then
            echo "| Node.js | ${{ steps.current.outputs.node_current }} | ${{ steps.latest.outputs.node_latest }} | âœ… Up to date |" >> version-report.md
          else
            echo "| Node.js | ${{ steps.current.outputs.node_current }} | ${{ steps.latest.outputs.node_latest }} | âš ï¸ Update available |" >> version-report.md
            UPDATES_AVAILABLE=true
          fi

          # Terraform
          if [ "${{ steps.current.outputs.terraform_current }}" = "${{ steps.latest.outputs.terraform_latest }}" ]; then
            echo "| Terraform | ${{ steps.current.outputs.terraform_current }} | ${{ steps.latest.outputs.terraform_latest }} | âœ… Up to date |" >> version-report.md
          else
            echo "| Terraform | ${{ steps.current.outputs.terraform_current }} | ${{ steps.latest.outputs.terraform_latest }} | âš ï¸ Update available |" >> version-report.md
            UPDATES_AVAILABLE=true
          fi

          # Ansible
          if [ "${{ steps.current.outputs.ansible_current }}" = "${{ steps.latest.outputs.ansible_latest }}" ]; then
            echo "| Ansible | ${{ steps.current.outputs.ansible_current }} | ${{ steps.latest.outputs.ansible_latest }} | âœ… Up to date |" >> version-report.md
          else
            echo "| Ansible | ${{ steps.current.outputs.ansible_current }} | ${{ steps.latest.outputs.ansible_latest }} | âš ï¸ Update available |" >> version-report.md
            UPDATES_AVAILABLE=true
          fi

          # kubectl
          if [ "${{ steps.current.outputs.kubectl_current }}" = "${{ steps.latest.outputs.kubectl_latest }}" ]; then
            echo "| kubectl | ${{ steps.current.outputs.kubectl_current }} | ${{ steps.latest.outputs.kubectl_latest }} | âœ… Up to date |" >> version-report.md
          else
            echo "| kubectl | ${{ steps.current.outputs.kubectl_current }} | ${{ steps.latest.outputs.kubectl_latest }} | âš ï¸ Update available |" >> version-report.md
            UPDATES_AVAILABLE=true
          fi

          # Helm
          if [ "${{ steps.current.outputs.helm_current }}" = "${{ steps.latest.outputs.helm_latest }}" ]; then
            echo "| Helm | ${{ steps.current.outputs.helm_current }} | ${{ steps.latest.outputs.helm_latest }} | âœ… Up to date |" >> version-report.md
          else
            echo "| Helm | ${{ steps.current.outputs.helm_current }} | ${{ steps.latest.outputs.helm_latest }} | âš ï¸ Update available |" >> version-report.md
            UPDATES_AVAILABLE=true
          fi

          # Kustomize
          if [ "${{ steps.current.outputs.kustomize_current }}" = "${{ steps.latest.outputs.kustomize_latest }}" ]; then
            echo "| Kustomize | ${{ steps.current.outputs.kustomize_current }} | ${{ steps.latest.outputs.kustomize_latest }} | âœ… Up to date |" >> version-report.md
          else
            echo "| Kustomize | ${{ steps.current.outputs.kustomize_current }} | ${{ steps.latest.outputs.kustomize_latest }} | âš ï¸ Update available |" >> version-report.md
            UPDATES_AVAILABLE=true
          fi

          # yq
          if [ "${{ steps.current.outputs.yq_current }}" = "${{ steps.latest.outputs.yq_latest }}" ]; then
            echo "| yq | ${{ steps.current.outputs.yq_current }} | ${{ steps.latest.outputs.yq_latest }} | âœ… Up to date |" >> version-report.md
          else
            echo "| yq | ${{ steps.current.outputs.yq_current }} | ${{ steps.latest.outputs.yq_latest }} | âš ï¸ Update available |" >> version-report.md
            UPDATES_AVAILABLE=true
          fi

          cat >> version-report.md <<'EOF'

          ## ðŸ“ Notes

          - **Node.js**: Using LTS version for stability
          - **Terraform**: Using 1.9.x (stable for CI/CD, not latest 1.14.x)
          - **kubectl**: Using 1.31.x for broad K8s compatibility
          - **Helm**: Using v3.x (v4 is too new for production CI/CD)

          ## ðŸ”— Links

          - [Node.js Releases](https://nodejs.org/en/download/releases/)
          - [Terraform Releases](https://releases.hashicorp.com/terraform/)
          - [Ansible PyPI](https://pypi.org/project/ansible/)
          - [kubectl Releases](https://kubernetes.io/releases/)
          - [Helm Releases](https://github.com/helm/helm/releases)
          - [Kustomize Releases](https://github.com/kubernetes-sigs/kustomize/releases)
          - [yq Releases](https://github.com/mikefarah/yq/releases)

          ---

          Generated on: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          EOF

          cat version-report.md

          echo "updates_available=$UPDATES_AVAILABLE" >> $GITHUB_OUTPUT

      - name: Create or update issue
        if: steps.compare.outputs.updates_available == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create labels if they don't exist (ignore errors if they already exist)
          gh label create "version-update" --description "Tool version updates available" --color "0366d6" 2>/dev/null || true
          gh label create "dependencies" --description "Dependency updates" --color "0366d6" 2>/dev/null || true

          # Check if an open issue already exists with our title pattern
          ISSUE_NUMBER=$(gh issue list \
            --state open \
            --search "Tool Version Updates Available in:title" \
            --json number \
            --jq '.[0].number // empty')

          if [ -z "$ISSUE_NUMBER" ]; then
            # Create new issue
            gh issue create \
              --title "ðŸ“¦ Tool Version Updates Available" \
              --body-file version-report.md \
              --label "version-update" \
              --label "dependencies"
            echo "âœ… Created new version update issue"
          else
            # Update existing issue
            gh issue edit "$ISSUE_NUMBER" \
              --body-file version-report.md
            gh issue comment "$ISSUE_NUMBER" \
              --body "ðŸ”„ Version check updated on $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "âœ… Updated existing issue #$ISSUE_NUMBER"
          fi

      - name: Upload report artifact
        uses: actions/upload-artifact@v6
        with:
          name: version-report
          path: version-report.md
          retention-days: 90

      - name: Job summary
        run: |
          cat version-report.md >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.compare.outputs.updates_available }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Action Required**: Some tools have updates available. Check the created/updated issue for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **All tools are up to date!**" >> $GITHUB_STEP_SUMMARY
          fi
